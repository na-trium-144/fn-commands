describe("fn-commands", function()
  it("should generate the correct state for sample 102399.1", function()
    -- Load libraries
    local fn = require("fn-commands")
    local json = require("rxi-json-lua")

    -- To ensure a clean state for the test, re-initialize the module.
    -- This resets the state table.
    fn.init()

    -- Execute the sample file which uses global functions (Note, Step, etc.)
    -- to populate the fn.state table.
    dofile("./samples/102399.1.lua")

    -- Load the expected result from the pre-generated JSON file
    local expected_f = assert(io.open("./samples/102399.1.json", "r"))
    local expected_json = expected_f:read("*a")
    expected_f:close()
    local expected_table = json.decode(expected_json)

    -- Compare the state generated by the library with the expected table.
    -- assert.same performs a deep, recursive comparison of the tables.
    assert.same(expected_table, fn.state)
  end)
end)
